import org.openhab.core.library.types.*
import org.openhab.core.persistence.*
import org.openhab.model.script.actions.*
import java.util.StringTokenizer

var String ArduinoLuminosityUpdate = ""


rule Startup
when 
	System started
then
	say("Welcome at openHab!")
end

rule Goodbye
when 
	System shuts down
then
	say("Good bye!")
end

rule "MAJ LuminositÃ© hall Arduino"
when
	Item Arduino received update
	then
		ArduinoLuminosityUpdate = ArduinoLuminosityUpdate + Arduino.state.toString.trim
		println("Arduino Luminosity Update : " + ArduinoLuminosityUpdate)
		val updates = ArduinoLuminosityUpdate.split("\n")
		for(update : updates) {
			println("update -> " + update)
			if (update.contains("Luminosity") && update.contains("=")) {
				var IndexLum = update.indexOf("=")
				var Number lum = Integer::parseInt(update.substring(IndexLum + 1, update.indexOf(";")))
				lum = lum * 100 / 155
				if (lum == 0) {
					sendCommand(Light_GF_Hall, OFF)
				} else {
					sendCommand(Light_GF_Hall, ON)
				}
				postUpdate(Luminosite_Hall, lum)
			}
		}
		ArduinoLuminosityUpdate = ""
		sendCommand(Arduino, "ok")
end

rule "test"
when
	Item Light_Presence received command
	then
		sendCommand(Arduino, "salut")
end
